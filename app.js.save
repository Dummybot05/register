const express = require('express');
const app = express();
const ejs = require('ejs');
const path = require('path');
const { MongoClient, ServerApiVersion } = require('mongodb');
const uri = "mongodb+srv://dummybot:Dummybot@study0.hfbb5dy.mongodb.net/?retryWrites=true&w=majority";

const client = new MongoClient(uri, {
  serverApi: {
    version: ServerApiVersion.v1,
    strict: true,
    deprecationErrors: true,
  }
});
/*
const nodemailer = require('nodemailer');

const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: 'dummybot0505@gmail.com',
    pass: 'Dummybot@0505'
  }
});

const otpGenerator = require('otp-generator');

const generateOTP = () => {
  const otp = otpGenerator.generate(6, { digits: true, alphabets: false, upperCase: false, specialChars: false });
  return otp;
};

const sendOTP = (email, otp) => {
  const mailOptions = {
    from: 'dummybot0505@gmail.com',
    to: email,
    subject: 'OTP for Login',
    text: `Your OTP is: ${otp}`
  };

  transporter.sendMail(mailOptions, function(error, info){
    if (error) {
      console.log('Error sending email:', error);
    } else {
      console.log('Email sent:', info.response);
    }
  });
};

sendOTP("damasatish8017@gmail.com", 123456);
*/

"use strict";
const nodemailer = require("nodemailer");

// async..await is not allowed in global scope, must use a wrapper
async function main() {
  // Generate test SMTP service account from ethereal.email
  // Only needed if you don't have a real mail account for testing
  let testAccount = await nodemailer.createTestAccount();

  // create reusable transporter object using the default SMTP transport
  let transporter = nodemailer.createTransport({
    host: "smtp.ethereal.email",
    port: 587,
    secure: false, // true for 465, false for other ports
    auth: {
      user: testAccount.user, // generated ethereal user
      pass: testAccount.pass, // generated ethereal password
    },
  });

  // send mail with defined transport object
  let info = await transporter.sendMail({
    from: '"Fred Foo ðŸ‘»" dummybot0505@gmail.com',
    to: "damasatish8017@gmail.com",
    subject: "Hello âœ”",
    text: "Hello world?",
    html: "<b>Hello world?</b>",
  });

  console.log("Message sent: %s", info.messageId);
  // Message sent: <b658f8ca-6296-ccf4-8306-87d57a0b4321@example.com>

  // Preview only available when sending through an Ethereal account
  console.log("Preview URL: %s", nodemailer.getTestMessageUrl(info));
  // Preview URL: https://ethereal.email/message/WaQKMgKddxQDoou...
}

main().catch(console.error);


app.use(express.static('public'));
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
app.use(express.urlencoded({ extended: true }));

app.get('/', function(req, res){
  res.render('home');
});

var errAns = "";
app.get('/form', function(req, res){
   res.render('form', { errTick: errAns });
   errAns = "";
})

app.get("/success", function(req, res) {
     res.send("Success Admission");
})

app.post('/data', function(req, res){
    const name = req.body.name;
    const fname = req.body.fname;
    const mname = req.body.mname;
    const dob = req.body.dob;
    const gender = req.body.gender;
    const email = req.body.email;
    const mob = req.body.mob;
    const fmob = req.body.fmob;
    const aadhar = req.body.aadhar;
    const pan = req.body.pan;
    const mole1 = req.body.mole1;
    const mole2 = req.body.mole2;
    const chkbx = req.body.chkbx;

    if(chkbx == "" || chkbx == undefined) {
       errAns = "Please Tick";
       res.redirect("form");
    } else {
       if(name == "" || name.length < 3) {
         errAns = "Enter valid name";
         res.redirect("form");
       } else {
          if(fname == "" || fname.length < 3) {
             errAns = "Enter valid Father name";
             res.redirect("form");
          } else {
             if(mname == "" || mname.length < 3) {
                errAns = "Enter valid Mother name";
                res.redirect("form");
             } else {
                if(dob == "") {
                   errAns = "Please choose a date";
                   res.redirect("form");
                } else {
	      	   if(gender == "" || gender == undefined) {
                      errAns = "Please choose a gender";
                      res.redirect("form");
                   } else {
   	              if(email == "" || email.length < 5) {
                         errAns = "Enter valid Email Id";
                         res.redirect("form");
                      } else {
			 if(mob == "" || mob.length < 10) {
                            errAns = "Enter valid Mobile number";
                            res.redirect("form");
                         } else {
                            if(fmob == "" || fmob.length < 10) {
                               errAns = "Enter valid Father Mobile number";
                               res.redirect("form");
                            } else {
                               if(aadhar == "" || aadhar.length < 12) {
                                  errAns = "Enter valid Aadhar number";
                                  res.redirect("form");
                               } else {
                                  if(pan == "" || pan.length < 10) {
                                     errAns = "Enter valid Pan number";
                                     res.redirect("form");
                                  } else {
       				     if(mole1 == "") {
                                        errAns = "Please Enter Mole1";
                                        res.redirect("form");
                                     } else {
                 			if(mole2 == "") {
                                           errAns = "Please Enter Mole2";
                                           res.redirect("form");
                                        } else {
//start
  async function run() {
      try {
        const database = client.db("studentDetails");
        const student = database.collection("students");
        const doc = {
           name: name,
           fname: fname,
           mname: mname,
           dob: dob,
           gender: gender,
           email: email,
           mob: mob,
           fmob: fmob,
           aadhar: aadhar,
           pan: pan,
           mole1: mole1,
           mole2: mole2,
           chkbx: chkbx
        }
        const result = await student.insertOne(doc);
        res.redirect("/success");
      } finally {
          await client.close();
      }
  }
  run().catch(console.dir);
//end
					}
				     }
				  }
			       }
		       	    }
		         }
		      }
		   }
		}
             }
          }
       }
    }
})

app.listen(3000, function(){
  console.log('Server listening on port 3000');
});
